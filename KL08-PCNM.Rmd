---
title: "PCNM for KL 2008"
author: "Alicia Halhed"
date: "02/04/2020"
output: word_document
---

# Set up

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# set working directory
setwd("~/OneDrive - University of Guelph/Alicia's Thesis/red-squirrel-w2020")
# attach required packages
library(tidyverse)
library(qiime2R)
library(vegan)
```

## Read in the Data
```{r}
# GET the metadata
rs_q2_metadata <- read.table("~/OneDrive - University of Guelph/Alicia's Thesis/red-squirrel-w2020/RS_meta.tsv", sep="\t")
colnames(rs_q2_metadata) <- c("SampleID", "Grid", "Location X", "Location Y", "Sex", "Age", "Month", "Season", "Year", "Squirrel.ID", "SireID", "DamID", "CollectionDate", "FoodSupplement", "BirthYear", "Location", "Date")
View(rs_q2_metadata)
```

```{r}
# build phyloseq object
ps <- qza_to_phyloseq(features = "/home/ahalhed/red-squirrel-w2020/filtered-table.qza",
                      tree = "/home/ahalhed/red-squirrel-w2020/trees/rooted_tree.qza",
                      taxonomy = "/home/ahalhed/red-squirrel-w2020/taxonomy/GG-taxonomy.qza",
                      metadata = "/home/ahalhed/red-squirrel-w2020/input/RS_meta.tsv")
```

## Functions for Analysis
```{r, Functions}
# subset the XY's by grid and year
XY_year <- function(metadata, grid, year) {
  df1 <- subset(metadata, Grid == grid, 
         select = c("SampleID", "Location X", "Location Y", "Year"))
  df2 <- subset(df1, Year == year, 
         select = c("SampleID", "Location X", "Location Y"))
  df3 <- column_to_rownames(remove_rownames(df2), var = "SampleID")
  return(df3)
}

# maximum distance
max_dist <- function(dm) {
  df1 <- as.data.frame(as.matrix(dm))
  # functions is soft deprecated (replace with functions or lambdas)
  summ <- summarise_each(df1, ~ max(df1, na.rm=TRUE))
  m <- apply(summ, 1, max)
  return(m)
}

# numeric metadata (depends on dplyr)
Grid_numeric <- function(metadata, grid, year) {
  df1 <- subset(metadata, Grid == grid) %>%
    remove_rownames() %>%
    column_to_rownames(., var = "SampleID") %>%
    subset(., Year == year)
  df2 <- df1 %>%
    # want sex and food supplement to be numeric
    # male 0, female 1; no 0, yes 1
    mutate(Sex = as.integer(recode(Sex, "Male" = 0, "Female" = 1)),
           FoodSupplement = as.integer(recode(FoodSupplement, 
                                   "No" = 0, "Yes" = 1)))
  df3 <- Filter(is.numeric, df2)
  drop <- c("Location X", "Location Y", "Date")
  df4 <- df3[,!(names(df3) %in% drop)]
  return(df4)
}
```

# Initial analysis
```{r}
# XY data
XY_08_KL <- XY_year(rs_q2_metadata, "KL", 2008)
# numeric data for CCA
numeric_08_KL <- Grid_numeric(rs_q2_metadata, "KL", 2008)
```

```{r}
# Compute Euclidean Distance
e_08_KL <- dist(XY_08_KL, method = "e")
# checking what the highest values are in the dm
# to help decide the Neighbour threshold
max_dist(e_08_KL) #27.04163
```

PCNM
```{r}
# setting threshold to 5
# unweighted PCNM
pcnm_08_KL <- pcnm(e_08_KL, 5)
# weighted PCNM
# get OTUs (aka a community matrix)
comm_08_KL <- otu_table(ps) %>% as.matrix %>% 
    as.data.frame %>% 
    t %>% as.data.frame %>% 
    subset(., row.names(.) %in% rownames(XY_08_KL)) %>%
    .[ rowSums(.)>0, ]
# get the metadata subset
meta_08_KL <- rs_q2_metadata %>% subset(., SampleID %in% rownames(XY_08_KL))
# calculate weighted PCNM
Wpcnm_08_KL <- pcnm(dist(XY_08_KL, method = "e"), 
                    w = rowSums(comm_08_KL)/sum(comm_08_KL))
# CCA - might need to change explanatories
cca_08_KL <- cca(comm_08_KL ~ scores(Wpcnm_08_KL) + Sex + Season + Age, meta_08_KL)
```

```{r}
# look at the PCNM values
pcnm_all_08_KL$vectors
Wpcnm_all_08_KL$vectors
# look at CCA summary
# what is significance? most important?
summary(cca_08_KL)
```

# Spatial partitioning of CCA (mso)
```{r}
# from vegan
# section 14.4 in numerical ecology
# multiscale ordination
mso_08_KL <- mso(PCNM_CCA(XY_all[[1]], ps, numeric_all[[1]]), XY_all[[1]])
```

```{r}
# AG, JO, LL got peanut butter
#par(mfrow=c(2,4))
# 08 AG
msoplot(mso_1, ylim = c(0, 43), main="2008 AG")
# 08_CH
msoplot(mso_2, ylim = c(0, 15), main="2008 CJ")
# 08_JO
msoplot(mso_3, ylim = c(0, 12), main="2008 JO")
# 08_KL
msoplot(mso_4, ylim = c(0, 45), main="2008 KL")
# 09_KL
msoplot(mso_5, ylim = c(0, 24), main="2009 KL")
# 10_KL
msoplot(mso_6, ylim = c(0, 41), main="2010 KL")
# 08_LL
msoplot(mso_7, ylim = c(0, 17), main="2008 LL")
# 08_SU
msoplot(mso_8, ylim = c(0, 12), main="2008 SU")
```

# Variance partitioning
```{r}
# looping variance partitioning
OTU_vp <- function(env, ps, pcnm) {
  rn <- rownames(env)
  # relies on dplyr and phyloseq
  otu <- otu_table(ps) %>% as.matrix %>% 
    as.data.frame %>% 
    t %>% as.data.frame %>% 
    subset(., row.names(.) %in% rn) %>%
    .[ rowSums(.)>0, ]
  var <- varpart(otu, ~ ., pcnm, data=env, 
                 transfo="hel", chisquare = TRUE)
  return(var)
}
```

Variance partitioning (stuck on this for now)
```{r}
OTU_vp(numeric_all[[1]], ps, Wpcnm_all[[1]])
# ...
varpart(numeric_all[[1]])
variance_paritition_full <- varpart(numeric_df)
```