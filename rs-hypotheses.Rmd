---
title: "Red Squirrel Proposal Hypotheses"
author: "Alicia Halhed"
date: "20/03/2020"
output: word_document
---

## Set Up
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# set working directory
setwd("~/OneDrive - University of Guelph/Alicia's Thesis/red-squirrel-w2020/R-env")
# attach required packages
library(phyloseq)
library(vegan)
library(qiime2R)
library(tidyverse)
```

```{r}
# get the metadata
rs_q2_metadata <- read.table("~/OneDrive - University of Guelph/Alicia's Thesis/red-squirrel-data/original/metadata_all_samples.tsv", sep = "\t", header = TRUE) %>%
  mutate(CollectionDate = lubridate::ymd(CollectionDate))
```

Load distance matrices (for dbRDA)
```{r}
# jaccard distances
rs_dm_jaccard <- read_qza("/home/ahalhed/red-squirrel-w2020/core-metrics-phylogenetic/jaccard_distance_matrix.qza")
# bray-curtis distances
rs_dm_bray <- read_qza("/home/ahalhed/red-squirrel-w2020/core-metrics-phylogenetic/bray_curtis_distance_matrix.qza")
```
```{r}
# these are SHARCNET paths
# build phyloseq object
ps <- qza_to_phyloseq(features = "/home/ahalhed/red-squirrel-w2020/filtered-table.qza",
                      tree = "/home/ahalhed/red-squirrel-w2020/trees/rooted_tree.qza",
                      taxonomy = "/home/ahalhed/red-squirrel-w2020/taxonomy/GG-taxonomy.qza",
                      metadata = "/home/ahalhed/red-squirrel-w2020/input/RS_meta.tsv")
```

## Proposal Figure 3
```{r}
# load in PCoA
rs_PCoA_jaccard <- read_qza("~/OneDrive - University of Guelph/Alicia's Thesis/red-squirrel-w2020/core-metrics-phylogenetic/jaccard_pcoa_results.qza")
```
```{r}
# combine PCoA with metadata
rs_PCoA_V <- left_join(rs_PCoA_jaccard$data$Vectors, rs_q2_metadata)
View(rs_PCoA_V)
```
### dbRDA (using  vegan)
```{r}
# get the OTU table in the right format (community matrix)
rs_comm <- otu_table(ps) %>% as.matrix %>% 
    as.data.frame %>% t %>% as.data.frame %>%
    .[ rowSums(.)>0, ]
#View(rs_comm)
```

```{r}
# could Collection Month in here (maybe)
# jaccard
rs_capJ <- capscale(dm_phylo_jaccard$data ~ factor(Grid) + CollectionDate + Age,
         data = rs_q2_metadata, comm = rs_comm, na.action = na.exclude)
# bray-curtis
rs_capBC <- capscale(dm_phylo_bray$data ~ factor(Grid) + CollectionDate + Age,
         data = rs_q2_metadata, comm = rs_comm, na.action = na.exclude)
```
#### dbRDA (using phyloseq)
this was taking forever on sharcnet, so holding off on it for now
```{r}
# ordinate for bray-curtis
# could also give it a distance matrix to save computing here (rs_dm_bray$data)
rs_ordi_bc <- ordinate(ps, "CAP", "bray", ~Year+Grid+Age+Sex)
# ordinate for jaccard
rs_ordi_j <- ordinate(ps, "CAP", "jaccard", ~Year+Grid+Age+Sex)
```
### Panel 3-1 
Ordination of grids
#### PCoA
```{r}
# axes 1 and 2
rs_3_1 <- ggplot(rs_PCoA_V, 
                       aes(x=PC1, y=PC2, col = Grid, group = Squirrel.ID)) + 
  geom_point() + # points are samples
  theme_bw()
rs_3_1
# add individual lines
rs_3_1 + geom_line() # lines are individuals
# add ellipses by grid
rs_3_1 + stat_ellipse(aes(group=Grid))
# add ellipses by grid and individual lines
# panel by season and year
rs_3_1 + 
  geom_line() + 
  stat_ellipse(aes(group=Grid)) +
  facet_grid(Season~Year)
```
#### dbRDA 
Biplot
```{r}
# the 6 x's represent a grid
plot(rs_capJ, main = "Jaccard")
plot(rs_capBC, main = "Bary-Curtis")
```
GGplot
```{r}
# join site scores with metadata
rs_df_capJ <- scores(rs_capJ)$sites %>% as.data.frame() %>% 
  rownames_to_column(var= "SampleID") %>%
  left_join(., rs_q2_metadata)
rs_df_capBC <- scores(rs_capBC)$sites %>% as.data.frame() %>% 
  rownames_to_column(var= "SampleID") %>%
  left_join(., rs_q2_metadata)
# look at joined data
View(rs_df_capJ)
View(rs_df_capBC)
```


```{r}
# jaccard ordination plot
ggplot(rs_df_capJ, aes(x=CAP1, y=CAP2, col = Grid, group = Squirrel.ID)) +
  ggtitle("Jaccard") + geom_point() + 
  coord_cartesian(ylim = c(-5,5), xlim = c(-5,5)) +
  theme_bw() + stat_ellipse(type = "norm", aes(group = Grid))
# add ellipses by grid and individual lines
# panel by season and year
ggplot(rs_df_capJ, aes(x=CAP1, y=CAP2, col = Grid, group = Squirrel.ID)) +
  ggtitle("Jaccard") + geom_point() + geom_line() +
  theme_bw() + stat_ellipse(type = "norm", aes(group = Grid)) +
  coord_cartesian(ylim = c(-5.5,5), xlim = c(-5.5,5)) +
  facet_grid(Season~Year)
```
```{r}
# bray-curtis ordination plot
ggplot(rs_df_capBC, aes(x=CAP1, y=CAP2, col = Grid, group = Squirrel.ID)) +
  ggtitle("Bray-Curtis") + geom_point() +
  theme_bw() + stat_ellipse(type = "norm", aes(group = Grid))
# add ellipses by grid and individual lines
# panel by season and year
ggplot(rs_df_capBC, aes(x=CAP1, y=CAP2, col = Grid, group = Squirrel.ID)) +
  ggtitle("Bray-Curtis") + geom_point() + geom_line() +
  theme_bw() + stat_ellipse(type = "norm", aes(group = Grid)) +
  facet_grid(Season~Year)
```

### Panel 3-2 
Ordination of grids with diet
#### PCoA
```{r}
# axes 1 and 2
rs_3_2 <- ggplot(rs_PCoA_V, aes(x=PC1, y=PC2, group = Squirrel.ID, shape = FoodSupplement)) + #, shape = Grid
  geom_point() + # points are samples
  # add lines connecting individuals?
  #geom_line() +
  # just keep 2008
  theme_bw() + #facet_grid(Year~.) +
  # each grid is an ellipse, coloured by food supplementation
  stat_ellipse(aes(group=Grid, colour=FoodSupplement)) 
rs_3_2
```
#### dbRDA
```{r}
# jaccard
ggplot(rs_df_capJ, aes(x=CAP1, y=CAP2, group = Squirrel.ID, shape = FoodSupplement)) + #, shape = Grid
  geom_point() + # points are samples
  # add lines connecting individuals?
  #geom_line() +
  # just keep 2008
  theme_bw() + #facet_grid(Year~.) +
  coord_cartesian(ylim = c(-5,5), xlim = c(-5,5)) +
  # each grid is an ellipse, coloured by food supplementation
  stat_ellipse(aes(group=Grid, colour=FoodSupplement)) 
```
```{r}
# Bray-Curtis
ggplot(rs_df_capBC, aes(x=CAP1, y=CAP2, group = Squirrel.ID, shape = FoodSupplement)) + #, shape = Grid
  geom_point() + # points are samples
  # add lines connecting individuals?
  #geom_line() +
  # just keep 2008
  theme_bw() + #facet_grid(Year~.) +
  coord_cartesian(ylim = c(-7,7), xlim = c(-7,7)) +
  # each grid is an ellipse, coloured by food supplementation
  stat_ellipse(aes(group=Grid, colour=FoodSupplement)) 
```

### Panel 3-3 
Ordination of grids with parent-offspring relationships
#### PCoA
```{r, message=FALSE, warning=FALSE}
# Sire
# axes 1 and 2
rs_3_3S <- ggplot(rs_PCoA_V, aes(x=PC1, y=PC2, col = as.character(SireID))) + 
  geom_point() + # points are samples
  guides(col = F) +
  theme_bw()
rs_3_3S
# add facetting by grid and year
rs_3_3S + facet_grid(Year~Grid)
# add ellipse (specific sires)
rs_3_3S + stat_ellipse(aes(group=as.character(SireID), colour=as.character(SireID)))
# add ellipse with facetting
rs_3_3S + facet_grid(Year~Grid) +
  stat_ellipse(aes(group=as.character(SireID), 
                   colour=as.character(SireID)))
```

```{r, message=FALSE, warning=FALSE}
# Dam
# axes 1 and 2
rs_3_3 <- ggplot(rs_PCoA_V, aes(x=PC1, y=PC2, col = as.character(DamID))) + 
  geom_point() + # points are samples
  guides(col = F) +
  theme_bw()
rs_3_3
# add facetting by grid and year
rs_3_3 + facet_grid(Year~Grid)
# add ellipse (specific dams)
rs_3_3 + stat_ellipse(aes(group=as.character(DamID), colour=as.character(DamID)))
# add ellipse with facetting
rs_3_3 + facet_grid(Year~Grid) +
  stat_ellipse(aes(group=as.character(DamID), 
                   colour=as.character(DamID)))
# parent offspring by line
```


#### dbRDA
```{r, message=FALSE, warning=FALSE}
# jaccard
# Sire
# axes 1 and 2
rs_3_3S <- ggplot(rs_df_capJ, aes(x=CAP1, y=CAP2, col = as.character(SireID))) + 
  geom_point() + # points are samples
  guides(col = F) +
  coord_cartesian(ylim = c(-5,5), xlim = c(-5,5)) +
  theme_bw() + ggtitle("Jaccard Sire")
rs_3_3S
# add facetting by grid and year
rs_3_3S + facet_grid(Year~Grid)
# add ellipse (specific sires)
rs_3_3S + coord_cartesian(ylim = c(-10,13), xlim = c(-10,13)) +
  stat_ellipse(aes(group=as.character(SireID), colour=as.character(SireID)))
# add ellipse with facetting
rs_3_3S + facet_grid(Year~Grid) +
  stat_ellipse(aes(group=as.character(SireID), 
                   colour=as.character(SireID)))
# Dam
# axes 1 and 2
rs_3_3 <- ggplot(rs_df_capJ, aes(x=CAP1, y=CAP2, col = as.character(DamID))) + 
  geom_point() + # points are samples
  guides(col = F) +
  theme_bw() + ggtitle("Jaccard Dam") +
  coord_cartesian(ylim = c(-5,5), xlim = c(-5,5))
rs_3_3
# add facetting by grid and year
rs_3_3 + facet_grid(Year~Grid)
# add ellipse (specific dams)
rs_3_3 + coord_cartesian(ylim = c(-10,10), xlim = c(-10,10)) +
  stat_ellipse(aes(group=as.character(DamID), colour=as.character(DamID)))
# add ellipse with facetting
rs_3_3 + facet_grid(Year~Grid) +
  stat_ellipse(aes(group=as.character(DamID), 
                   colour=as.character(DamID)))
```

```{r, message=FALSE, warning=FALSE}
# bray-curtis
# Sire
# axes 1 and 2
rs_3_3S <- ggplot(rs_df_capBC, aes(x=CAP1, y=CAP2, col = as.character(SireID))) + 
  geom_point() + # points are samples
  guides(col = F) +
  coord_cartesian(ylim = c(-6.5,6), xlim = c(-6.5,6)) +
  theme_bw() + ggtitle("Bray-Curtis Sire")
rs_3_3S
# add facetting by grid and year
rs_3_3S + facet_grid(Year~Grid)
# add ellipse (specific sires)
rs_3_3S + coord_cartesian(ylim = c(-13,15), xlim = c(-13,15)) +
  stat_ellipse(aes(group=as.character(SireID), colour=as.character(SireID)))
# add ellipse with facetting
rs_3_3S + facet_grid(Year~Grid) +
  stat_ellipse(aes(group=as.character(SireID), 
                   colour=as.character(SireID)))
# Dam
# axes 1 and 2
rs_3_3 <- ggplot(rs_df_capBC, aes(x=CAP1, y=CAP2, col = as.character(DamID))) + 
  geom_point() + # points are samples
  guides(col = F) +
  coord_cartesian(ylim = c(-6.5,6), xlim = c(-6.5,6)) +
  theme_bw() + ggtitle("Bray-Curtis Dam")
rs_3_3
# add facetting by grid and year
rs_3_3 + facet_grid(Year~Grid)
# add ellipse (specific dams)
rs_3_3 + coord_cartesian(ylim = c(-12,12), xlim = c(-12,12)) +
  stat_ellipse(aes(group=as.character(DamID), colour=as.character(DamID)))
# add ellipse with facetting
rs_3_3 + facet_grid(Year~Grid) +
  stat_ellipse(aes(group=as.character(DamID), 
                   colour=as.character(DamID)))
```

### Panel 3-4
Ordination of grids with movement between grids.
Since I don't really have movement between grids, going to colour points by their X Y location and facet by replicate (grid/year).
#### PCoA
```{r, message=FALSE, warning=FALSE}
rs_PCoA_V %>%
  mutate("Location" = paste(Location.X, Location.Y, sep = ", ")) %>%
  # axes 1 and 2
  ggplot(., aes(x=PC1, y=PC2, col = Location)) + 
  geom_point() + # points are samples
  facet_grid(Year~Grid) +
  guides(col=FALSE) +
  theme_bw()
```
#### dbRDA
```{r, message=FALSE, warning=FALSE}
# jaccard
rs_df_capJ %>%
  mutate("Location" = paste(Location.X, Location.Y, sep = ", ")) %>%
  # axes 1 and 2
  ggplot(., aes(x=CAP1, y=CAP2, col = Location)) + 
  geom_point() + # points are samples
  facet_grid(Year~Grid) +
  coord_cartesian(ylim = c(-5,5), xlim = c(-5,5)) +
  guides(col=FALSE) +
  theme_bw()
```
```{r, message=FALSE, warning=FALSE}
# bray-curtis
rs_df_capBC %>%
  mutate("Location" = paste(Location.X, Location.Y, sep = ", ")) %>%
  # axes 1 and 2
  ggplot(., aes(x=CAP1, y=CAP2, col = Location)) + 
  coord_cartesian(ylim = c(-6,6), xlim = c(-6,6)) +
  geom_point() + # points are samples
  facet_grid(Year~Grid) +
  guides(col=FALSE) +
  theme_bw()
```

## Proposal Figure 4
```{r}
rs_jaccard <- read_qza("~/OneDrive - University of Guelph/Alicia's Thesis/red-squirrel-w2020/core-metrics-phylogenetic/jaccard_distance_matrix.qza")$data %>% 
  as.matrix %>% as.data.frame %>%
  rownames_to_column("sampleid1") %>%
  pivot_longer(-sampleid1, names_to = "sampleid2", values_to = "Jaccard") %>%
  unique() %>% left_join(., rs_q2_metadata, 
                        by = c("sampleid1" = "SampleID")) %>%
  # .x for sample 1, .y for sample 2
  left_join(., rs_q2_metadata, by = c("sampleid2" = "SampleID"))
View(rs_jaccard)
```

```{r}
# create a new column with the relationship between individuals
# if there is an NA in either of the DamID/SireID columns, then the relationship cannot be determined (so is therefore an NA)
rs_jaccard$Relationship <- ifelse(rs_jaccard$Squirrel.ID.x == rs_jaccard$Squirrel.ID.y, "self",
  ifelse(rs_jaccard$Squirrel.ID.x == rs_jaccard$DamID.y | rs_jaccard$Squirrel.ID.y == rs_jaccard$DamID.x, 
         "mother-offspring",
    ifelse(rs_jaccard$Squirrel.ID.x == rs_jaccard$SireID.y | rs_jaccard$Squirrel.ID.y == rs_jaccard$SireID.x, 
           "father-offspring", 
      ifelse(rs_jaccard$DamID.x == rs_jaccard$DamID.y & rs_jaccard$SireID.x == rs_jaccard$SireID.y, 
             "full-sibling",
        ifelse(rs_jaccard$DamID.x == rs_jaccard$DamID.y | rs_jaccard$SireID.x == rs_jaccard$SireID.y, 
               "half-sibling",
          "unrelated")))))
```

```{r}
# create a new grid column
rs_jaccard$Grid <- ifelse(rs_jaccard$Grid.x == rs_jaccard$Grid.y, "Same Grid", "Different Grid")
# create a new, more specific grid column
rs_jaccard$GridS <- ifelse(rs_jaccard$Grid.x == "KL" & rs_jaccard$Grid.x == rs_jaccard$Grid.y, "KL",
                           ifelse(rs_jaccard$Grid.x == "AG" & rs_jaccard$Grid.x == rs_jaccard$Grid.y, "AG",
                                  ifelse(rs_jaccard$Grid.x == "JO" & rs_jaccard$Grid.x == rs_jaccard$Grid.y, "JO",
                                         ifelse(rs_jaccard$Grid.x == "LL" & rs_jaccard$Grid.x == rs_jaccard$Grid.y, "LL",
                                                ifelse(rs_jaccard$Grid.x == "CH" & rs_jaccard$Grid.x == rs_jaccard$Grid.y, "CH",
                                                       "Different Grid")))))
```

```{r}
# cread a new year column
rs_jaccard$Year <- ifelse(rs_jaccard$Year.x == rs_jaccard$Year.y, "Same Year", "Different Year")
# cread a new, more specific year column
rs_jaccard$YearS <- ifelse(rs_jaccard$Year.x == 2008 & rs_jaccard$Year.x == rs_jaccard$Year.y, 2008, 
                          ifelse(rs_jaccard$Year.x == 2009 & rs_jaccard$Year.x == rs_jaccard$Year.y, 2009,
                                 ifelse(rs_jaccard$Year.x == 2010 & rs_jaccard$Year.x == rs_jaccard$Year.y, 2010,
                                        "Different Year")))
```

```{r}
# new food supplement column
rs_jaccard$FoodSupplement <- ifelse(rs_jaccard$FoodSupplement.x == "No" & rs_jaccard$FoodSupplement.x == rs_jaccard$FoodSupplement.y, "No", 
                                    ifelse(rs_jaccard$FoodSupplement.x == "Yes" & rs_jaccard$FoodSupplement.x == rs_jaccard$FoodSupplement.y, "Yes", "Either"))
```

### Left Panel
Boxplot of dissimilarity of shared diets
```{r}
# remove rows where the relationship is unknown and the distance is 0 (meaning it is comparing a sample to itself)
rs_4L <- rs_jaccard %>% filter(Jaccard > 0) %>%
  # make a boxplot
  ggplot(., aes(x = FoodSupplement, y = Jaccard)) + 
  geom_boxplot() + 
  # modify theme and tick text
  theme_bw() +
  # reorder x axis
  scale_x_discrete(limits=c("Either","Yes","No"))
rs_4L
# add general facet (grid, year)
rs_4L + facet_grid(Year~Grid)
# add specific facet (grid, year)
rs_4L + facet_grid(YearS~GridS)
```

### Right Panel
Boxplot of dissimilarity of parent-offspring pairs vs whole grid (this is very similar to what the original paper had - I have just adjusted the facetting they had)

```{r}
# remove rows where the relationship is unknown and the distance is 0 (meaning it is comparing a sample to itself)
rs_jaccard %>% 
  drop_na(Relationship) %>%
  filter(Jaccard > 0) %>%
  # make a boxplot
  ggplot(., aes(x = Relationship, y = Jaccard)) + 
  geom_boxplot() + facet_grid(Year~Grid) +
  # modify theme and tick text
  theme_bw() + theme(axis.text.x = element_text(angle = 34, hjust = 1)) +
  # the relatinoships have been reordered to match the ones in the paper
  scale_x_discrete(limits=c("self","mother-offspring","father-offspring", "full-sibling", "half-sibling", "unrelated"))
```

## Proposal Figure 5
Line graph of dissimilarity between the focal individual and others sampled from the same location over time
I am going to focus on individuals sampled at two locations (ideally multiple times at both locations)

```{r}
# add location information
rs_jaccard$Location <- ifelse(rs_jaccard$sampleid1 == rs_jaccard$sampleid2, "Same Sample",
                                ifelse(rs_jaccard$`Grid.x` != rs_jaccard$`Grid.y`, "Different Grid",
                                  ifelse(rs_jaccard$`Squirrel.ID.x` == rs_jaccard$`Squirrel.ID.y` &
                                           rs_jaccard$`Location.X.x` == rs_jaccard$`Location.X.y` &
                                           rs_jaccard$`Location.Y.x` == rs_jaccard$`Location.Y.y`,
                                     "Same Squirrel, Same Location",
                                     ifelse(rs_jaccard$Squirrel.ID.x != rs_jaccard$Squirrel.ID.y &
                                              rs_jaccard$`Location.X.x` == rs_jaccard$`Location.X.y` &
                                              rs_jaccard$`Location.Y.x` == rs_jaccard$`Location.Y.y`,
                                     "Different Squirrel, Same Location",
                                     ifelse(rs_jaccard$Squirrel.ID.x != rs_jaccard$Squirrel.ID.y &
                                              rs_jaccard$`Location.X.x` != rs_jaccard$`Location.X.y` |
                                              rs_jaccard$`Location.Y.x` != rs_jaccard$`Location.Y.y`,
                                     "Different Squirrel, Different Location",
                                     ifelse(rs_jaccard$Squirrel.ID.x == rs_jaccard$Squirrel.ID.y &
                                              rs_jaccard$`Location.X.x` != rs_jaccard$`Location.X.y` |
                                              rs_jaccard$`Location.Y.x` != rs_jaccard$`Location.Y.y`,
                                     "Same Squirrel, Different Location", NA))))))
# add date information
rs_jaccard$CollectionDate <- ifelse(rs_jaccard$CollectionDate.x == rs_jaccard$CollectionDate.y,
                                    "Same Date", "Different Date")
# look at data
View(rs_jaccard)
```

```{r}
rs_5 <- rs_jaccard %>% filter(Jaccard > 0) %>%
  group_by(Squirrel.ID.x, Location, CollectionDate, CollectionDate.x) %>%
  # find mean distance from squirrel to others samples
  summarise_at(vars(Jaccard), ~ mean(., na.rm=TRUE))  %>%
  # extract year and day/month information
  mutate("Year" = word(CollectionDate.x, 1, sep = "-"),
         "Month" = word(CollectionDate.x, 2, sep = "-"),
         "Day" = word(CollectionDate.x, 3, sep = "-"))
View(rs_5)
```

```{r}
# look at plot, facetted by collection date and location
ggplot(rs_5, aes(x = CollectionDate.x, y = Jaccard, group = Squirrel.ID.x, col = Squirrel.ID.x)) +
  geom_line() + theme_bw() + facet_grid(Location~CollectionDate)
```

```{r}
rs_5 %>%
  # only interested in distances to other individuals at the same location
  filter(., Location %in% "Different Squirrel, Same Location") %>%
  # wanted to take into account same date, but greatly reduces sample numbers
  #filter(., CollectionDate %in% "Same Date") %>%
  ggplot(., aes(x = CollectionDate.x, y = Jaccard, group = Squirrel.ID.x, col = Squirrel.ID.x)) +
  geom_line() + theme_bw() + #facet_grid(Month~.) +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

